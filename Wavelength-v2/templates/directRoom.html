{% extends "base.html" %}

{% block content %}
<div style="border-top: double; border-bottom: double;">
    <div class="message-box">
        <h2>Direct Chat Room: {{ room }}</h2>  <!-- Shows the 4-digit room code -->
        {% if recipient %}
            <p>Chatting with: {{ recipient.full_name }}</p>
        {% endif %}
        <div class="messages" id="messages"></div>

        <div class="inputs">
            <input type="text" rows="3" placeholder="Message" name="message" id="message"/>  <!-- Message input -->
            <button type="button" name="send" id="send-btn" onClick="sendMessage()">Send</button>  <!-- Send button -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl.min.js"></script>
    <script src="{{ url_for('static', filename=("generateSymmetric.js")) }}"></script>
    <script type="text/javascript">
    var socketio = io(); // initialize socket.io

    // Join the room on page load
    socketio.emit("join_direct_room", { room: "{{ room }}" });

    const messages = document.getElementById("messages");

    const createMessage = (name, msg) => {
        const content = `
            <div class="text">
                <span><strong>${name}</strong> ~ ${msg}</span>
            </div>
        `;
        messages.innerHTML += content;
    };

    socketio.on("message", (data) => {
        createMessage(data.name, data.message);
    });

    const sendMessage = () => {
        const messageInput = document.getElementById("message");
        const message = messageInput.value.trim();
        if (message.value === "") return;

        socketio.emit("direct_message", {
            room: "{{ room }}",
            data: message
        });

        message.value = "";
    };

    document.addEventListener('DOMContentLoaded', async function () {

        let room = "{{ room }}"
        let currentUsername = "{{ currentUser.username }}"
        let recipientId = "{{ recipient.user_id }}"
        let recipientPublicKey = "{{ recipient.public_key }}"
        let [encryptedKeyBase64, nonceBase64] = generateSymmetricKey(room, currentUsername, recipientPublicKey)
        const payload = {
            room: room,
            encryptedKey: encryptedKeyBase64,
            nonce: nonceBase64,
            sender: "{{ currentUser.public_key }}"
        };

        async function sendSymmetricKey(recipientId, payload) {
            try {
                const response = await fetch('/api/send_symmetric_key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        recipient_id: recipientId,
                        room: room,
                        symmetric_key: payload
                    })
                });

                if (response.ok) {
                    console.log('Symmetric key sent successfully!');
                } else {
                    console.error('Failed to send symmetric key.');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        await sendSymmetricKey(recipientId, payload);

    });
    </script>

</div>
{% endblock %}