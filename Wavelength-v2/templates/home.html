{% extends 'base.html' %}
{% block content %}
<div style="background:linen; border-bottom: double; border-top: double; width: 100%; padding:30px;">
    <div style="text-align:center; font-weight:bolder; font-family:'Press Start 2P', sans-serif; text-shadow:-2px 2px 1px lightsteelblue;">Welcome to<br><br>
        <span style="font-weight:bolder; font-size:32pt; text-shadow:-5px 5px lightsteelblue;">~~Wavelength~~</span></div>
    <br><br>

    <div class="fancybox2">
        <h4 style="text-shadow: -2px 2px 1px lightsteelblue;">~Security~</h4>
        We provide your
        company a secure and streamlined
        way to communicate business-sensitive information
        with a lightweight and fast
        framework that uses encryption
        to secure your
        messages.
    </div>
    <div class="fancybox2">
        <h4 style="text-shadow: -2px 2px 1px lightsteelblue;">~Open Source~</h4>
        Our code is open source,
        inspired by the open source
        works of other companies.
    </div>
    <div class="fancybox2">
        <h4 style="text-shadow: -2px 2px 1px lightsteelblue;">~Simple~</h4>
        Do away with super complex applications,
        and embrace this brand new, homegrown
        application, made with love.
    </div>
    <div class="fancybox2">
        <h4 style="text-shadow: -2px 2px 1px lightsteelblue;">~Something else~</h4>
        This is mostly for troubleshooting.
        There's really nothing else to add here
    </div>
    <div class="fancybox2">
        <h4 style="text-shadow: -2px 2px 1px lightsteelblue;">~My Opinion~</h4>
        I came up with this design over a weekend,
        and I think it's pretty cool. Very visually
        appealing in my opinion.
    </div>
</div>
 <script>
      document.addEventListener("DOMContentLoaded", async () => {
        {% if just_logged_in %}
        await fetchMailbox();
        {% endif %}
      });

      async function fetchMailbox() {
        try {
            const response = await fetch('/api/fetch_mailbox');
            const messages = await response.json();

            messages.forEach(entry => {
              if (entry.type === "symmetric_key") {
                const room = entry.payload.room;
                const symmetricPayload = JSON.parse(entry.payload.symmetric_key);
                const currentUsername = "{{ currentUser.username }}"
                var secretKey = localStorage.getItem("wavelength_"+ currentUsername + "PrivateKey")

                const decryptedSymmetricKey = nacl.box.open(
                  symmetricPayload.encryptedKey,  // the encrypted symmetric key
                  symmetricPayload.nonce,         // nonce used during encryption
                  symmetricPayload.sender,         // sender's public key (Uint8Array)
                  secretKey  // recipient's secret key (Uint8Array)
                );

                localStorage.setItem("wavelength_" + room + "SymmetricKey", decryptedSymmetricKey);
              }
            });
        } catch (error) {
            console.error("Failed to set up symmetric key in localstorage", error.message)
        }
      }
</script>
{% endblock %}